@()

<!DOCTYPE html>

<html>
    <head>
        <title>Monitoring</title>
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/main.css")">
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("bootstrap/css/bootstrap.min.css")">
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/noty/jquery.noty.css")">
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/noty/noty_theme_twitter.css")">
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/monitor.min.css")" />
        <link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.png")">
        <script src="@routes.Assets.at("javascripts/jquery-1.7.1.min.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/jquery.quicksearch.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/jquery.tablesorter.min.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/mustache.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/main.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("bootstrap/js/bootstrap.min.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("bootstrap/js/bootstrap-modal.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/jquery.noty.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/promise.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/zanimo.min.js")" type="text/javascript"></script>
    </head>
    <body>

        <script type="text/javascript">
            function create(elt) {
                return window.document.createElement(elt);
            }

            function SpeedOMeter(config) {
                this.maxVal = config.maxVal;
                this.unit = config.unit ? config.unit + " " : "";
                this.name = config.name;
                this.container = config.container;
                this.elt = create("div");
                this.elt.className = "monitor";

                var title = create("span");
                title.innerHTML = this.name;
                title.className = 'title';
                this.elt.appendChild(title);

                this.screenCurrent = create("span");
                this.screenCurrent.className = 'screen current';
                this.elt.appendChild(this.screenCurrent);

                this.screenMax = create("span");
                this.screenMax.className = 'screen max';
                this.screenMax.innerHTML = this.maxVal + this.unit;
                this.elt.appendChild(this.screenMax);

                this.needle = create("div");
                this.needle.className = "needle";
                this.elt.appendChild(this.needle);

                this.light = create("div");
                this.light.className = "green light";
                this.elt.appendChild(this.light);

                var wheel = create("div");
                wheel.className = "wheel";
                this.elt.appendChild(wheel);

                this.container.appendChild(this.elt);
            }

            SpeedOMeter.prototype.red = function () {
                this.light.className = "red light";
            };

            SpeedOMeter.prototype.green = function () {
                this.light.className = "red green";
            };

            SpeedOMeter.prototype.update = function (val) {
                Zanimo.transition(
                        this.needle,
                        "transform",
                        "rotate(" + (val > this.maxVal ? 175 : val * 170 / this.maxVal) + "deg)",
                        500,
                        "ease-in"
                );
                this.screenCurrent.innerHTML = val + this.unit;
            }

            var threads
            var memory
            //var loads
            var cpu
            var lastCall

            function init() {
                threads = new SpeedOMeter({
                    name : "THREADS",
                    maxVal : 300,
                    container : window.document.body
                })

                memory = new SpeedOMeter({
                    name : "MEMORY",
                    maxVal : 1024,
                    unit : "MB",
                    container : window.document.body
                })

                cpu = new SpeedOMeter({
                    name : "CPU",
                    maxVal : 100,
                    unit : "%",
                    container : window.document.body
                })

                /**loads = new SpeedOMeter({
                    name : "LOAD",
                    maxVal : 1,
                    container : window.document.body
                })**/
            }

            function updateUI( data) {
                if (data.thread != undefined) {
                    threads.update(data.thread)
                }
                if (data.mem != undefined) {
                    memory.update(data.mem)
                }
                /**if (data.load != undefined) {
                    loads.update(data.load)
                }**/
                if (data.cpu != undefined) {
                    cpu.update(data.cpu)
                }
            }

            function openSSEConnection() {
                var pushSource = new EventSource( '@routes.MonitorController.monitorSource()' )
                pushSource.onmessage = function ( event ) {
                    var data = JSON.parse( event.data )
                    lastCall = (new Date()).getTime()
                    updateUI( data )
                }
            }

            $(document).ready(function() {
                init()
                setTimeout(openSSEConnection, 500)
                setInterval(function() {
                    if ((new Date()).getTime() - lastCall > 5000) {
                        threads.red()
                        memory.red()
                        cpu.red()
                        //loads.red()
                    }
                }, 300)
            })
        </script>
    </body>
</html>
